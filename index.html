<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CALMIO PEN – Análisis Semanal de Estrés</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Scripts de Google: sin onload, se inicializan al final -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f5f7fb;color:#1f2933;line-height:1.6;padding:20px;
    }
    .container{max-width:1100px;margin:0 auto}
    header{
      display:flex;justify-content:space-between;align-items:center;
      padding:20px 24px;margin-bottom:16px;border-radius:16px;
      background:#ffffff;box-shadow:0 4px 14px rgba(15,23,42,.08);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand-icon{font-size:28px}
    .brand-title{font-size:22px;font-weight:700;color:#0f766e}
    .tagline{font-size:13px;color:#64748b}
    .upload-card,.panel{
      background:#ffffff;border-radius:16px;padding:20px 24px;
      box-shadow:0 2px 10px rgba(15,23,42,.06);margin-bottom:20px;
    }
    h2{font-size:18px;margin-bottom:8px}
    p.desc{font-size:13px;color:#64748b;margin-bottom:12px}
    input[type="file"]{margin-top:8px}
    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:14px;margin-top:10px;
    }
    .stat{
      background:#f8fafc;border-radius:12px;padding:12px 14px;
      border-left:4px solid #0f766e;
    }
    .stat-label{font-size:12px;color:#64748b}
    .stat-value{font-size:22px;font-weight:700;color:#0f172a}
    .stat-extra{font-size:11px;color:#94a3b8}
    .charts-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;
    }
    .chart-box{height:260px}
    canvas{max-height:220px!important}
    .pill{
      display:inline-block;padding:4px 10px;border-radius:999px;
      font-size:11px;font-weight:600;
    }
    .pill-low{background:#ecfdf3;color:#15803d}
    .pill-med{background:#fffbeb;color:#b45309}
    .pill-high{background:#fef2f2;color:#b91c1c}
    .recommendation{
      padding:10px 12px;border-radius:10px;margin-bottom:8px;
      background:#f8fafc;border:1px solid #e2e8f0;font-size:13px;
      display:flex;gap:8px;
    }
    .rec-badge{
      min-width:22px;height:22px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:#0f766e;color:#ecfeff;font-size:11px;font-weight:700;
    }
    .badge-tag{
      display:inline-block;font-size:10px;padding:2px 8px;
      border-radius:999px;background:#e0f2fe;color:#0369a1;
      margin-right:6px;margin-top:4px;
    }
    .muted{font-size:12px;color:#94a3b8}
    .error{color:#b91c1c;font-size:13px;margin-top:6px}

    .nav-links{
      display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 20px;
    }
    .nav-btn{
      border:none;border-radius:999px;padding:6px 14px;
      font-size:12px;font-weight:600;cursor:pointer;
      background:#e0f2fe;color:#0369a1;
    }
    .nav-btn.primary{
      background:#0f766e;color:#ecfeff;
    }

    .inline-input{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 10px;
    }
    .inline-input input[type="text"]{
      padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;
      font-size:13px;min-width:220px;
    }
    .small-btn{
      border:none;border-radius:999px;padding:6px 12px;
      font-size:12px;font-weight:600;cursor:pointer;
      background:#0f766e;color:#ecfeff;
    }
    .small-btn.secondary{
      background:#e2e8f0;color:#475569;
    }
    .calendar-status{
      font-size:12px;color:#64748b;margin:6px 0;
    }
    .event-list{
      margin-top:10px;font-size:12px;color:#475569;
      max-height:180px;overflow-y:auto;
    }
    .event-item{
      padding:6px 8px;border-radius:8px;margin-bottom:4px;
      background:#f8fafc;border:1px solid #e2e8f0;
    }

    @media(max-width:700px){
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <span class="brand-icon">✍️</span>
      <div>
        <div class="brand-title">CALMIO PEN</div>
        <div class="tagline">Tu acompañante de salud mental para estudiar con calma</div>
      </div>
    </div>
    <div class="muted">
      Panel IA semanal<br>
      <strong>Sube tu archivo CSV para analizar tu estrés</strong>
    </div>
  </header>

  <div class="nav-links">
    <button class="nav-btn primary" onclick="scrollToSection('csvSection')">Ver análisis CSV</button>
    <button class="nav-btn" onclick="scrollToSection('calendarSection')">Vincular CALMIO PEN + Google Calendar</button>
  </div>

  <div class="upload-card" id="csvSection">
    <h2>1. Sube tus datos de la semana</h2>
    <p class="desc">
      Exporta desde Excel un archivo <strong>.csv</strong> con este formato mínimo:
      de>fecha,hora,nivel,pulsos,contexto</code>
      (ejemplo de nivel: LOW, MEDIUM, HIGH).
    </p>
    <input type="file" id="fileInput" accept=".csv">
    <div id="uploadError" class="error"></div>
  </div>

  <div class="panel">
    <h2>2. Resumen de tu semana</h2>
    <p class="desc" id="summaryText">Aún no hay datos cargados. Sube un CSV para ver tu análisis.</p>
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-label">Promedio de pulsos</div>
        <div class="stat-value" id="avgPulses">--</div>
        <div class="stat-extra">Por ventana de 10 s</div>
      </div>
      <div class="stat">
        <div class="stat-label">Distribución de niveles</div>
        <div class="stat-value" id="distLevels">--</div>
        <div class="stat-extra">
          <span class="pill pill-low" id="lowPct">Bajo --%</span>
          <span class="pill pill-med" id="medPct">Medio --%</span>
          <span class="pill pill-high" id="highPct">Alto --%</span>
        </div>
      </div>
      <div class="stat">
        <div class="stat-label">Días analizados</div>
        <div class="stat-value" id="daysCount">--</div>
        <div class="stat-extra" id="recordsCount">-- registros totales</div>
      </div>
      <div class="stat">
        <div class="stat-label">Momento más crítico</div>
        <div class="stat-value" id="worstContext">--</div>
        <div class="stat-extra" id="worstTime">--</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>3. Visualización de tu estrés</h2>
    <p class="desc">Explora cómo cambia tu nivel de estrés según el día, la hora y el tipo de actividad.</p>
    <div class="charts-grid">
      <div class="chart-box">
        <h3 class="muted">Estrés promedio por día</h3>
        anvas id="dayChart"></canvas>
      </div>
      <div class="chart-box">
        <h3 class="muted">Estrés por tipo de actividad</h3>
        anvas id="contextChart"></canvas>
      </div>
      <div class="chart-box">
        <h3 class="muted">Distribución LOW / MEDIUM / HIGH</h3>
        anvas id="levelChart"></canvas>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>4. Acompañamiento CALMIO (IA)</h2>
    <p class="desc">
      A partir de tus datos, CALMIO genera recomendaciones personalizadas para cuidar tu salud mental durante la próxima semana.
    </p>
    <div id="recsContainer">
      <p class="muted">Cuando subas tu archivo, aquí aparecerán recomendaciones específicas para ti.</p>
    </div>
  </div>

  <div class="panel" id="calendarSection">
    <h2>5. Vincula tu CALMIO PEN y Google Calendar</h2>
    <p class="desc">
      Aquí podrás asociar tu dispositivo con tu cuenta de Google Calendar para que CALMIO sepa en qué tipo de evento estabas
      cuando manipulaste mucho el lápiz (clase, examen, trabajo en grupo, etc.). Esta sección solo lee tus eventos; no modifica tu calendario. [web:1459][web:1468][web:1471]
    </p>

    <div class="inline-input">
      <label for="penCodeInput" class="muted">Código de tu CALMIO PEN:</label>
      <input type="text" id="penCodeInput" placeholder="Ej: CALMIO-1234">
      <button class="small-btn" onclick="savePenCode()">Guardar</button>
      <span class="muted" id="penCodeStatus"></span>
    </div>

    <div class="inline-input">
      <button id="authorize_button" class="small-btn" style="display:none" onclick="handleAuthClick()">Conectar con Google Calendar</button>
      <button id="signout_button" class="small-btn secondary" style="display:none" onclick="handleSignoutClick()">Desconectar</button>
    </div>
    <div class="calendar-status" id="calendarStatus">
      Aún no has conectado tu Google Calendar.
    </div>

    <div class="event-list" id="events"></div>

    <p class="muted" style="margin-top:8px;">
      En el prototipo, estos eventos se usan como “pseudo‑datos” para saber en qué estabas cuando tu CALMIO PEN detecte mucha actividad.
      Más adelante, estos datos se cruzarán automáticamente con tus registros semanales de estrés. [web:1403][web:1391][web:1400]
    </p>
  </div>
</div>

<script>
  function scrollToSection(id){
    const el = document.getElementById(id);
    if(el){ el.scrollIntoView({behavior:"smooth"}); }
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) return [];
    const header = lines[0].split(",").map(h => h.trim().toLowerCase());
    const idxFecha = header.indexOf("fecha");
    const idxHora = header.indexOf("hora");
    const idxNivel = header.indexOf("nivel");
    const idxPulsos = header.indexOf("pulsos");
    const idxContexto = header.indexOf("contexto");
    if (idxFecha === -1 || idxHora === -1 || idxNivel === -1 || idxPulsos === -1) {
      throw new Error("El CSV debe tener al menos las columnas: fecha,hora,nivel,pulsos,contexto");
    }
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const cols = lines[i].split(",");
      const obj = {
        fecha: (cols[idxFecha] || "").trim(),
        hora: (cols[idxHora] || "").trim(),
        nivel: (cols[idxNivel] || "").trim().toUpperCase(),
        pulsos: Number((cols[idxPulsos] || "0").trim()) || 0,
        contexto: idxContexto !== -1 ? (cols[idxContexto] || "").trim() : "Sin contexto"
      };
      data.push(obj);
    }
    return data;
  }

  function computeStats(rows) {
    const stats = {
      total: rows.length,
      avgPulsos: 0,
      perNivel: { LOW:0, MEDIUM:0, HIGH:0 },
      perDia: {},
      perContexto: {},
      worstContext: null,
      worstHour: null
    };
    if (!rows.length) return stats;
    let sum = 0;
    let maxPulsos = -1;
    rows.forEach(r => {
      sum += r.pulsos;
      if (stats.perNivel[r.nivel] !== undefined) stats.perNivel[r.nivel]++;
      if (!stats.perDia[r.fecha]) stats.perDia[r.fecha] = {sum:0,count:0};
      stats.perDia[r.fecha].sum += r.pulsos;
      stats.perDia[r.fecha].count++;
      if (!stats.perContexto[r.contexto]) stats.perContexto[r.contexto] = {sum:0,count:0};
      stats.perContexto[r.contexto].sum += r.pulsos;
      stats.perContexto[r.contexto].count++;
      if (r.pulsos > maxPulsos) {
        maxPulsos = r.pulsos;
        stats.worstContext = r.contexto;
        stats.worstHour = r.hora + " (" + r.fecha + ")";
      }
    });
    stats.avgPulsos = sum / rows.length;
    return stats;
  }

  function buildRecommendations(stats) {
    const recs = [];
    const total = stats.total || 1;
    const pctHigh = (stats.perNivel.HIGH / total) * 100;
    const pctMed = (stats.perNivel.MEDIUM / total) * 100;
    const pctLow = (stats.perNivel.LOW / total) * 100;

    if (pctHigh > 40) {
      recs.push({ tag: "Alerta alta",
        text: "Tu semana mostró muchos picos de estrés alto. Programa pausas obligatorias de 5 minutos cada 25 minutos de estudio y evita acumular trabajo para el último momento." });
    } else if (pctHigh > 20) {
      recs.push({ tag: "Vigilar",
        text: "Aparecen bastantes momentos de estrés alto. Usa tu CALMIO PEN cada vez que notes inquietud en las manos para hacer 2 ciclos de respiración profunda guiada." });
    } else {
      recs.push({ tag: "Buen control",
        text: "Tus niveles de estrés alto se mantienen bajo control. Mantén tus rutinas actuales y sigue utilizando el CALMIO PEN como recordatorio de respiración consciente." });
    }

    if (pctMed > 40) {
      recs.push({ tag: "Estrés sostenido",
        text: "Pasaste gran parte del tiempo en estrés moderado. Prueba a planificar tu semana el domingo por la noche para reducir la sensación de carga constante." });
    }

    const contextEntries = Object.entries(stats.perContexto).map(
      ([ctx, v]) => ({ctx, avg: v.sum / v.count})
    ).sort((a,b)=>b.avg-a.avg);

    if (contextEntries.length) {
      const top = contextEntries[0];
      recs.push({
        tag: "Contexto crítico",
        text: `Tu contexto más estresante fue "${top.ctx}". Antes de entrar en ese tipo de actividad, haz 3 respiraciones profundas con el CALMIO PEN y define un objetivo pequeño y concreto para esa sesión.`
      });
    }

    if (pctLow < 30) {
      recs.push({ tag: "Recuperación",
        text: "Tu cuerpo casi no pasa a estado de calma completa. Intenta añadir micro-pausas sin pantalla (mirar por la ventana, estirar, beber agua) entre bloques de estudio." });
    } else {
      recs.push({ tag: "Recuperación adecuada",
        text: "Se observa buen tiempo en estado de calma. Mantén esos espacios de desconexión: son clave para consolidar lo que estudias." });
    }
    return recs;
  }

  let dayChart, contextChart, levelChart;

  function renderCharts(stats) {
    const dayCtx = document.getElementById("dayChart").getContext("2d");
    const ctxCtx = document.getElementById("contextChart").getContext("2d");
    const levelCtx = document.getElementById("levelChart").getContext("2d");
    if (dayChart) dayChart.destroy();
    if (contextChart) contextChart.destroy();
    if (levelChart) levelChart.destroy();

    const dayLabels = Object.keys(stats.perDia);
    const dayData = dayLabels.map(d => stats.perDia[d].sum / stats.perDia[d].count);

    dayChart = new Chart(dayCtx, {
      type: "line",
      data: { labels: dayLabels,
        datasets: [{ label: "Pulsos promedio",
          data: dayData,
          borderColor: "#0f766e",
          backgroundColor: "rgba(15,118,110,0.15)",
          tension: 0.35,
          fill: true }]},
      options: {responsive:true,maintainAspectRatio:false}
    });

    const ctxLabels = Object.keys(stats.perContexto);
    const ctxData = ctxLabels.map(c => stats.perContexto[c].sum / stats.perContexto[c].count);

    contextChart = new Chart(ctxCtx, {
      type: "bar",
      data: { labels: ctxLabels,
        datasets: [{ label: "Pulsos promedio",
          data: ctxData,
          backgroundColor: "#3b82f6" }]},
      options: {responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });

    const total = stats.total || 1;
    levelChart = new Chart(levelCtx, {
      type: "doughnut",
      data: { labels: ["LOW","MEDIUM","HIGH"],
        datasets: [{ data: [
            stats.perNivel.LOW,
            stats.perNivel.MEDIUM,
            stats.perNivel.HIGH
          ],
          backgroundColor:["#22c55e","#fbbf24","#ef4444"] }]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  }

  document.getElementById("fileInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    const errorDiv = document.getElementById("uploadError");
    errorDiv.textContent = "";
    if (!file) return;
    if (!file.name.endsWith(".csv")) {
      errorDiv.textContent = "Por favor selecciona un archivo .csv exportado desde Excel.";
      return;
    }
    const text = await file.text();
    let rows;
    try {
      rows = parseCSV(text);
    } catch (err) {
      errorDiv.textContent = err.message;
      return;
    }
    if (!rows.length) {
      errorDiv.textContent = "El archivo no contiene datos válidos.";
      return;
    }

    const stats = computeStats(rows);
    const total = stats.total || 1;
    const pctLow = (stats.perNivel.LOW / total) * 100;
    const pctMed = (stats.perNivel.MEDIUM / total) * 100;
    const pctHigh = (stats.perNivel.HIGH / total) * 100;

    document.getElementById("avgPulses").textContent = stats.avgPulsos.toFixed(1);
    document.getElementById("distLevels").textContent = `${pctLow.toFixed(0)}% / ${pctMed.toFixed(0)}% / ${pctHigh.toFixed(0)}%`;
    document.getElementById("lowPct").textContent = `Bajo ${pctLow.toFixed(0)}%`;
    document.getElementById("medPct").textContent = `Medio ${pctMed.toFixed(0)}%`;
    document.getElementById("highPct").textContent = `Alto ${pctHigh.toFixed(0)}%`;
    document.getElementById("daysCount").textContent = Object.keys(stats.perDia).length;
    document.getElementById("recordsCount").textContent = `${stats.total} registros`;
    document.getElementById("worstContext").textContent = stats.worstContext || "--";
    document.getElementById("worstTime").textContent = stats.worstHour || "--";
    document.getElementById("summaryText").textContent =
      "Este resumen se basa en los datos reales que tu CALMIO PEN registró durante la semana.";

    renderCharts(stats);
    const recs = buildRecommendations(stats);
    const recDiv = document.getElementById("recsContainer");
    recDiv.innerHTML = "";
    recs.forEach((r,i) => {
      const el = document.createElement("div");
      el.className = "recommendation";
      el.innerHTML = `
        <div class="rec-badge">${i+1}</div>
        <div>
          <span class="badge-tag">${r.tag}</span>
          <div>${r.text}</div>
        </div>
      `;
      recDiv.appendChild(el);
    });
  });

  function savePenCode(){
    const input = document.getElementById("penCodeInput");
    const code = input.value.trim();
    const status = document.getElementById("penCodeStatus");
    if(!code){
      status.textContent = " Ingresa un código válido.";
      return;
    }
    try{
      localStorage.setItem("calmioPenCode", code);
      status.textContent = " Código guardado.";
    }catch(e){
      status.textContent = " No se pudo guardar el código en este navegador.";
    }
  }

  (function(){
    const saved = localStorage.getItem("calmioPenCode");
    if(saved){
      document.getElementById("penCodeInput").value = saved;
      document.getElementById("penCodeStatus").textContent = " Código cargado.";
    }
  })();

  const CALMIO_API_KEY   = "AlzaSyBocbPCbNAvq1kzwIoMkP_qXBC-tSV_1hU";
  const CALMIO_CLIENT_ID = "937391993802-8shughr1t7spi15ov0ahikqkjj5u7mf5.apps.googleusercontent.com";
  const CALMIO_SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
  const CALMIO_DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";

  let gapiReady = false;
  let gisReady = false;
  let tokenClient = null;

  function gapiLoaded() {
    if (!window.gapi) return;
    gapi.load("client", async () => {
      try{
        await gapi.client.init({
          apiKey: CALMIO_API_KEY,
          discoveryDocs: [CALMIO_DISCOVERY_DOC],
        });
        gapiReady = true;
        maybeEnableCalendarButton();
      }catch(err){
        document.getElementById("calendarStatus").textContent =
          "Error inicializando Google Calendar (cliente). Revisa tu API key y sus restricciones.";
        console.error(err);
      }
    });
  }

  function gisLoaded() {
    if (!window.google || !google.accounts || !google.accounts.oauth2) return;
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CALMIO_CLIENT_ID,
      scope: CALMIO_SCOPES,
      callback: () => {}
    });
    gisReady = true;
    maybeEnableCalendarButton();
  }

  function maybeEnableCalendarButton() {
    if (gapiReady && gisReady) {
      document.getElementById("authorize_button").style.display = "inline-block";
    }
  }

  function handleAuthClick() {
    if (!tokenClient) {
      alert("La librería de Google aún no está lista. Recarga la página e inténtalo de nuevo.");
      return;
    }
    document.getElementById("calendarStatus").textContent =
      "Abriendo Google para conectar tu calendario...";
    tokenClient.callback = async (resp) => {
      if (resp.error) {
        console.error(resp);
        document.getElementById("calendarStatus").textContent =
          "No se pudo autorizar el acceso al calendario.";
        return;
      }
      document.getElementById("authorize_button").style.display = "none";
      document.getElementById("signout_button").style.display = "inline-block";
      document.getElementById("calendarStatus").textContent =
        "Google Calendar conectado. Leyendo tus próximos eventos...";
      await listUpcomingEvents();
    };
    tokenClient.requestAccessToken({ prompt: "consent" });
  }

  function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token) {
      google.accounts.oauth2.revoke(token.access_token);
      gapi.client.setToken(null);
    }
    document.getElementById("signout_button").style.display = "none";
    document.getElementById("authorize_button").style.display = "inline-block";
    document.getElementById("calendarStatus").textContent =
      "Se cerró la sesión de Google Calendar.";
    document.getElementById("events").innerHTML = "";
  }

  async function listUpcomingEvents() {
    const eventsDiv = document.getElementById("events");
    eventsDiv.innerHTML = "Cargando eventos...";
    try {
      const now = new Date().toISOString();
      const res = await gapi.client.calendar.events.list({
        calendarId: "primary",
        timeMin: now,
        showDeleted: false,
        singleEvents: true,
        maxResults: 10,
        orderBy: "startTime"
      });
      const events = res.result.items || [];
      if (!events.length) {
        eventsDiv.innerHTML = "<p class='muted'>No se encontraron eventos próximos.</p>";
        return;
      }
      eventsDiv.innerHTML = "";
      events.forEach(ev => {
        const start = ev.start.dateTime || ev.start.date;
        const end = ev.end.dateTime || ev.end.date;
        const el = document.createElement("div");
        el.className = "event-item";
        el.innerHTML = `<strong>${ev.summary || "Sin título"}</strong><br>
                        <span>${start} → ${end}</span>`;
        eventsDiv.appendChild(el);
      });
    } catch (err) {
      console.error(err);
      eventsDiv.innerHTML = "<p class='error'>No se pudieron leer los eventos del calendario.</p>";
    }
  }

  // Inicializar cuando todo ha cargado
  window.addEventListener("load", () => {
    gapiLoaded();
    gisLoaded();
  });
</script>
</body>
</html>
